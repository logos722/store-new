# Документация: Реализация согласия на обработку персональных данных

## Обзор

Реализована функциональность согласия на обработку персональных данных в модальном окне оформления заказа (`OrderModal`) с блокировкой полей формы до момента согласия пользователя.

## Основные компоненты

### 1. Страница политики конфиденциальности

**Путь:** `src/app/privacy/page.tsx`

- Server Component для оптимальной производительности
- SEO-оптимизированные метаданные
- Подробная информация о политике обработки данных
- Адаптивная верстка

### 2. Модальное окно заказа

**Путь:** `src/shared/components/orderModal/OrderModal.tsx`

#### Ключевые изменения:

**Состояние:**

- `privacyConsent: boolean` - состояние согласия (по умолчанию `false`)
- `consentError: boolean` - состояние ошибки валидации

**Функциональность:**

- ✅ Чекбокс согласия всегда активен и находится в начале формы
- ✅ Все поля формы и кнопка заблокированы, если `privacyConsent === false`
- ✅ Валидация при отправке формы
- ✅ Отображение ошибки при попытке отправки без согласия
- ✅ Ссылка на политику конфиденциальности открывается в новой вкладке

**Оптимизация производительности:**

- `useCallback` для обработчиков событий
- Мемоизация функций для предотвращения лишних рендеров

### 3. Тип данных заказа

**Путь:** `src/types/order.ts`

Добавлено обязательное поле:

```typescript
export interface OrderFormData {
  // ... existing fields
  privacyConsent: boolean; // Согласие на обработку персональных данных
}
```

### 4. Стили

**Путь:** `src/shared/components/orderModal/OrderModal.module.scss`

#### Новые стили:

- `.consentGroup` - контейнер для чекбокса согласия
- `.consentLabel` - лейбл чекбокса
- `.consentCheckbox` - стили чекбокса с улучшенной доступностью
- `.consentText` - текст согласия
- `.privacyLink` - ссылка на политику
- `.errorMessage` - сообщение об ошибке
- `.disabledField` - стили для заблокированных полей
- `.formDivider` - разделитель между чекбоксом и полями

#### Мобильная адаптивность:

**Breakpoints:**

- `max-width: 768px` - планшеты
- `max-width: 480px` - мобильные устройства

**Особенности мобильной версии:**

- Уменьшенные отступы для экономии пространства
- `font-size: 16px` для input полей (предотвращает zoom на iOS)
- Адаптивные размеры чекбокса
- Оптимизированные размеры модального окна

## Архитектурные решения

### 1. Безопасность

- **Принцип "отказ по умолчанию"**: `privacyConsent` по умолчанию `false`
- Блокировка всех полей до согласия
- Явная валидация на стороне клиента
- Невозможность отправить форму без согласия

### 2. Доступность (A11y)

```tsx
// ARIA атрибуты для чекбокса
aria-required="true"
aria-invalid={consentError}
aria-describedby={consentError ? 'consent-error' : undefined}

// ARIA атрибуты для сообщения об ошибке
role="alert"

// ARIA атрибуты для кнопки
aria-disabled={isFieldsDisabled}
aria-label="Закрыть модальное окно"
```

### 3. UX паттерны

- **Прогрессивное раскрытие**: поля появляются только после согласия
- **Визуальная обратная связь**:
  - Заблокированные поля выглядят неактивными
  - Красная рамка при ошибке валидации
  - Четкое сообщение об ошибке
- **Предотвращение ошибок**: блокировка вместо валидации после заполнения

### 4. Performance

- `useCallback` для предотвращения лишних рендеров
- Controlled components для оптимального управления состоянием
- Условный рендеринг сообщений об ошибках
- CSS transitions для плавной анимации

## Edge Cases

### Обработанные сценарии:

1. ✅ **Попытка отправки без согласия**
   - Форма не отправляется
   - Показывается сообщение об ошибке
2. ✅ **Клик по ссылке политики**

   - `e.stopPropagation()` предотвращает закрытие модального окна
   - Открывается в новой вкладке (`target="_blank"`)
   - `rel="noopener noreferrer"` для безопасности

3. ✅ **Изменение согласия после ошибки**

   - Ошибка автоматически сбрасывается при установке чекбокса

4. ✅ **Disabled поля**

   - Невозможно взаимодействовать с полями
   - `cursor: not-allowed` для визуальной индикации
   - Сохраняется валидация HTML5 (`required`)

5. ✅ **Мобильные устройства**
   - iOS не зумирует input при фокусе (font-size: 16px)
   - Адаптивные размеры для удобства нажатия

## Интеграция с существующим кодом

### Обратная совместимость:

Код в `src/app/cart/page.tsx` не требует изменений, так как:

- `handleOrderSubmit` уже принимает полный объект `OrderFormData`
- Новое поле `privacyConsent` автоматически передается в payload
- API может проигнорировать или валидировать это поле на бэкенде

### Backend интеграция (рекомендации):

```typescript
// src/app/api/orders/route.ts (пример валидации)
if (!payload.customerInfo.privacyConsent) {
  return new Response(
    JSON.stringify({ error: 'Privacy consent is required' }),
    { status: 400 },
  );
}
```

## Тестирование

### Чек-лист для ручного тестирования:

**Desktop:**

- [ ] Чекбокс согласия отображается корректно
- [ ] Поля заблокированы без согласия
- [ ] Кнопка заблокирована без согласия
- [ ] Ошибка показывается при попытке отправки без согласия
- [ ] Ссылка открывается в новой вкладке
- [ ] После установки чекбокса поля разблокируются
- [ ] Форма отправляется успешно с согласием

**Mobile:**

- [ ] Модальное окно адаптивно
- [ ] Чекбокс легко нажимается (достаточный размер)
- [ ] Текст читаем на маленьком экране
- [ ] iOS не зумирует поля ввода
- [ ] Прокрутка работает корректно

**Accessibility:**

- [ ] Навигация с клавиатуры работает
- [ ] Screen reader озвучивает все элементы
- [ ] Focus visible на всех интерактивных элементах
- [ ] ARIA атрибуты корректны

## Best Practices

### Соблюдённые принципы:

1. **TypeScript**: Строгая типизация всех props и состояний
2. **React Hooks**: Использование useCallback для оптимизации
3. **Controlled Components**: Полный контроль состояния формы
4. **ARIA**: Accessibility атрибуты для всех интерактивных элементов
5. **Semantic HTML**: Правильное использование `label`, `input[type="checkbox"]`
6. **BEM-подобная структура**: Модульные SCSS классы
7. **Mobile First**: Адаптивность с приоритетом мобильных
8. **Performance**: Минимизация ре-рендеров
9. **Security**: Принцип "безопасность по умолчанию"
10. **UX**: Прогрессивное раскрытие и четкая обратная связь

## Возможные улучшения

### Future enhancements:

1. **Валидация на сервере**: Добавить проверку `privacyConsent` в API
2. **Логирование**: Сохранять timestamp согласия пользователя
3. **Версионирование политики**: Отслеживать версию политики при согласии
4. **Аналитика**: Отслеживать, сколько пользователей не дают согласие
5. **A/B тестирование**: Тестировать разные формулировки текста
6. **Анимации**: Добавить плавные transition для блокировки/разблокировки полей
7. **Подсказки**: Tooltip с объяснением, зачем нужно согласие
8. **Сохранение согласия**: Сохранять согласие для авторизованных пользователей

## Поддержка

Для вопросов и предложений по улучшению функциональности обращайтесь к команде разработки.

---

**Дата создания:** 20.10.2025  
**Версия:** 1.0.0  
**Автор:** AI Assistant
